# QHM Migrator (QHM移行 WordPressプラグイン)

このプラグインは、QHMで作成したサイトをWordPressへ移行させることを支援します。詳しい使い方は、以下のページをご覧ください。


## 概要

このプラグインは、以下の機能を提供することでQHMからWordPressへの移行を手助けます。

QHMとWordPressをスイッチ表示
: 通常のアクセスでは、QHMを表示します。WordPressにログイン(wp-admin にアクセスする)すると、WordPressを表示します。この機能によって、編集者はWordPressを閲覧し、訪問者はQHMを見ることができます。裏側で、ゆっくりとWordPressを完成させることができます。

QHMのページとブログのインポート機能
: このプラグインは、QHMのページ内容をWordPressに取り込むことができます。ページは固定ページへ、QBlogは、ブログ投稿にカテゴリも含めて取り込みます。またページ内で使われている「画像」や「メディア」をWordPressに取り込みます。

QHMの過去のページURLへのアクセスを、WordPressへ転送
: QHMとWordPressのURLは違います。QHMは、 `/index.php?ページ名` ですが、WordPressは `/ページ名` となります。このためWordPressに切り替えると過去のページへのアクセスが無効になるため、この転送を行います。

QHMのページURLへのアクセスで発生するWordPressの無限ループ問題を解決
: QHMのページURLに日本語が含まれていると、WordPressではリダイレクトがループ（なんども起こり）エラーとなります。このプラグインによってその問題を回避することが可能です。存在しないページの場合、トップページに転送します。

ver0.9以前の `index_qhm.php` ページ問題を解決します
: ver0.9以前は、引っ越し中のとき、WordPressとQHMをスイッチするのではなく、QHMを index_qhm.php?ページ名 で動作させていました。また引っ越し作業中は、このindex_qhm.php に 302リダイレクトをしていました。
　これによりURLが変更されないようにしていましたが、転送先から先にクロールが行われる事態が発生し（長いこと公開されないことが主な原因）、SEO効果を下げてしまう現象がありました。このような現象になっているサイトの問題を解決します。方法は、index_qhm.php から、 index.php へ転送を行います。




## ご利用方法

以下のように作業をしてください。

1. **バックアップする** : いつでも、元に戻せるようにバックアップをしてください(FTPソフトを使うなどしてください)
2. **QHMと、PHPのバージョンを新しくする** : QHM v5.3以上、PHP5.6以上にあげてください。方法は、 <https://ensmall.net/> や、<https://help.toiee.jp/article/22-can-not-i-use-qhm> をご覧ください。なお、どちらも公式のサポートはありません。ご自身の責任で行ってください。
4. **WordPressをダウンロード** : WordPressの公式サイトで、最新のWordPressをダウンロードする
5. **WordPressのindex.phpを削除して、アップロードする** : WordPressをアップロードする前に、index.php を 削除してから、WordPressのシステムをアップロードします。 *忘れると、QHMが一時的に表示しなくなります* 。
7. **WordPressの初期設定** : /wp-admin/ にアクセスして、WordPressの設定を行います。事前にデータベースの作成、ユーザー追加などを行っておきます（お使いのレンタルサーバーのマニュアルを参照）
8. **QHM移行プラグインをインストール、有効化** : 上記のダウンロードリンクから、ダウンロードします。次に プラグイン > 新規インストール　でこのプラグインのファイルを指定し、アップロードし、有効化します
9. **indexファイルを適切に設定する** : WordPressの管理画面で、 設定>QHM移行 と進みます。indexファイルの設定のためのボタンをクリックして、適切に設定してください。
10. **QHMの移行作業** : 設定>QHM移行で、インポートなどができます。これらを使ってデータをインポートします。またWordPressの見た目などを調整します。
11. **QHM移行完了する** : 設定>QHM移行で、「公開」を設定します。すると、QHMを表示せず、WordPressを表示するようになります。QHMは一切表示されなくなります。過去のQHMをご覧になりたい場合は、QHMのindex.php ファイルを適当な名前 (index2.php) などに変更したものをアップし、このファイルにアクセスしてください。


## 仕様

### 仕組み

このプラグインは、 index_qhm_proxy.php にアクセスして、 `<!-- BODYCONTENTS START -->` から `<!-- BODYCONTENTS END -->` までのHTMLを取り込みます。取り込んだHTMLファイルを解析して、ブログ投稿に必要なタイトルなどを取得しています。
	
もし、QHMのテンプレートファイルを独自に改変して、上記のコメントが表示されない場合は正常に動作しません。

### 注意点

- ページ名が長すぎると（ 200byte以上 )、インポートをせず、エラーを表示します（ページ名を短くしてから、再度、インポートしてください）
- 移行中（WordPressとQHMがスイッチ動作しているとき）に、WordPressのURLや存在しないディレクトリやファイルへのアクセスは、QHMのトップページが表示されます。
- .htaccess、index.php などを不用意に変更（意図していなくても、SEO系プラグインや、QHMのインストーラーなどで）すると、動作がおかしくなることがありますのでご注意ください
- 移行中にQHMを表示したい場合は、WordPressをログアウトしてください。なお、同時にQHMもWordPressも見たい場合は、ブラウザの「プライベートウィンドウ（シークレットウインドウ）」機能をお使いください

### できること

- 隠しページ、通常のページを全て読み込みます
- :config や SiteNavigation などのコンテンツ以外のページは読み込みません
- ブログのカテゴリを登録、反映します
- ページ、ブログに使われている画像やファイルは、取り込まれますが、それ以外は取り込みません
- 取り込む対象のファイルは、swfu/d フォルダ以下に限ります


## Change log

- [詳細は、こちら](https://github.com/toiee-lab/wordpress-to-qhm-migrator/commits/master)

### ver 0.9
- WordPressとQHMをスイッチする（転送しない）ようになり、より安全に、確実に移行できるようになりました
- [index_qhm.php 問題について解決](https://github.com/toiee-lab/wordpress-to-qhm-migrator/issues/6)しました
- indexファイルを簡単に設定できるようになりました



### ver 0.8.4 (Aug 19, 2017)
- ナビ、サイドバー作成支援ツールのURLを変更
- アップデートファイルの置き場所を変更

### ver 0.8.3 (Aug 17, 2017)
- 長いファイル名のページを事前にチェックするだけでなく、問題が起こるページをすべてリストアップするように修正
- 名前を変える方法を解説したページリンクを追加

### ver 0.8.2 (Aug 14, 2017)
- 長いファイル名のページを事前にチェックして、インポートを中止するように設定しました
- ナビ、メニュー、フッターなどに貼り付けている画像も取り込むように変更しました

### ver 0.8.1 (Aug 9, 2017)
- index_wp.php, index_qhm.php が同封されていなかったので追加（GitHubに慣れてない)
- index.php が QHMのままの場合、修正する方法 (ver0.6で導入) が有効になっていなかった不具合を修正
- 移行を行いやすくするために、便利なリンクを追加しました

### ver 0.6 (Aug 8, 2017)
- アップデート通知を受け取れるように修正しました
- index.php、index_qhm.php が間違っているときに修正するための方法を追加しました

### ver 0.5 (Aug 7, 2017)

- WordPressにログインしているなら、QHMを公開している状態でも、index.php?XXXX を /XXXX/ に転送するように修正
- Readmeに移行のための手順を記載


### ver 0.4 (Jul 24, 2017)

**既存ページを読み込まないオプションの追加、attachを取り込む、実行時間の延長*

- 既存の投稿、ページをslug で検索をかけて、取り込まずにスキップできるようにしました
- これは、実行時間が短いサーバー、処理が遅いサーバー、ページが多すぎる場合に、数回に分けて、ページをインポートするのに役立ちます
- PHPの実行時間を180秒に延長することを試み見ます。これにより、かなり長く実行できるようになるはずです
- 今回のバージョンから、古い添付ファイル（refを使った attachフォルダのもの) も取り込めるように改良しました

### ver 0.3 (Jul 15, 2017)

**PHP5.6以上でないと動かないようにチェックをかける**

- PHP5.6以上でないと、動作できないように修正。
- 不要なコメントなどを削除
- PHPの実行環境情報を記載

### ver 0.2

**PHP5.4に対応**

- メンバ変数、メソッドの修飾子などを削除




